name: Build FastCopy

on:
  push:
    branches: [ master, main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

env:
  # vcpkg é…ç½®
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
  
  # æ„å»ºé…ç½®
  BUILD_CONFIGURATION: Release
  SOLUTION_FILE_PATH: ./FastCopy.sln
  
  # è¯ä¹¦é…ç½®
  CERTIFICATE_NAME: FastCopy-SelfSigned
  CERTIFICATE_PASSWORD: FastCopy123!

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        platform: [x64]
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '3426db05b996481ca31e95fff3734cf23e0f51bc'
        
    - name: Export GitHub Actions cache environment variables
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');
          
    - name: Install vcpkg dependencies
      run: |
        vcpkg install --triplet=${{ matrix.platform }}-windows
      working-directory: ${{ github.workspace }}
      
    - name: Generate self-signed certificate
      shell: powershell
      run: |
        # åˆ›å»ºè‡ªç­¾åè¯ä¹¦
        $cert = New-SelfSignedCertificate -Type CodeSigningCert -Subject "CN=FastCopy Developer" -KeyAlgorithm RSA -KeyLength 2048 -Provider "Microsoft Enhanced RSA and AES Cryptographic Provider" -KeyExportPolicy Exportable -KeyUsage DigitalSignature -CertStoreLocation Cert:\CurrentUser\My
        
        # å¯¼å‡ºè¯ä¹¦åˆ°æ–‡ä»¶
        $password = ConvertTo-SecureString -String "$env:CERTIFICATE_PASSWORD" -Force -AsPlainText
        Export-PfxCertificate -cert "Cert:\CurrentUser\My\$($cert.thumbprint)" -FilePath "$env:CERTIFICATE_NAME.pfx" -Password $password
        
        # å°†è¯ä¹¦æ·»åŠ åˆ°å—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„å­˜å‚¨åŒºï¼ˆç”¨äºæœ¬åœ°æµ‹è¯•ï¼‰
        Export-Certificate -Cert "Cert:\CurrentUser\My\$($cert.thumbprint)" -FilePath "$env:CERTIFICATE_NAME.crt"
        Import-Certificate -FilePath "$env:CERTIFICATE_NAME.crt" -CertStoreLocation Cert:\LocalMachine\Root
        Import-Certificate -FilePath "$env:CERTIFICATE_NAME.crt" -CertStoreLocation Cert:\LocalMachine\TrustedPublisher
        
        echo "Certificate generated successfully"
        echo "Certificate thumbprint: $($cert.thumbprint)"
        
    - name: Update Package.appxmanifest with certificate info
      shell: powershell
      run: |
        # è¯»å– Package.appxmanifest æ–‡ä»¶
        $manifestPath = "FastCopy\Package.appxmanifest"
        [xml]$manifest = Get-Content $manifestPath
        
        # æ›´æ–° Publisher ä¿¡æ¯ä»¥åŒ¹é…è¯ä¹¦
        $manifest.Package.Identity.Publisher = "CN=FastCopy Developer"
        
        # ä¿å­˜ä¿®æ”¹åçš„æ–‡ä»¶
        $manifest.Save((Resolve-Path $manifestPath))
        echo "Updated Package.appxmanifest with certificate publisher info"
        
    - name: Restore NuGet packages
      run: nuget restore ${{ env.SOLUTION_FILE_PATH }}
      
    - name: Build solution
      run: |
        msbuild ${{ env.SOLUTION_FILE_PATH }} /m /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=${{ matrix.platform }} /p:AppxBundlePlatforms="${{ matrix.platform }}" /p:AppxPackageDir="${{ github.workspace }}\AppPackages\" /p:AppxBundle=Always /p:UapAppxPackageBuildMode=StoreUpload /p:PackageCertificateKeyFile="${{ env.CERTIFICATE_NAME }}.pfx" /p:PackageCertificatePassword=${{ env.CERTIFICATE_PASSWORD }}
        
    - name: Sign the package
      shell: powershell
      run: |
        # æŸ¥æ‰¾ç”Ÿæˆçš„ appx/appxbundle æ–‡ä»¶
        $packageFiles = Get-ChildItem -Path "AppPackages" -Recurse -Include "*.appx", "*.appxbundle", "*.msix", "*.msixbundle"
        
        foreach ($package in $packageFiles) {
          echo "Signing package: $($package.FullName)"
          & signtool sign /fd SHA256 /a /f "$env:CERTIFICATE_NAME.pfx" /p "$env:CERTIFICATE_PASSWORD" "$($package.FullName)"
          
          if ($LASTEXITCODE -eq 0) {
            echo "Successfully signed: $($package.Name)"
          } else {
            echo "Failed to sign: $($package.Name)"
          }
        }
        
    - name: Verify package signatures
      shell: powershell
      run: |
        $packageFiles = Get-ChildItem -Path "AppPackages" -Recurse -Include "*.appx", "*.appxbundle", "*.msix", "*.msixbundle"
        
        foreach ($package in $packageFiles) {
          echo "Verifying signature for: $($package.Name)"
          & signtool verify /pa "$($package.FullName)"
        }
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: FastCopy-${{ matrix.platform }}-${{ env.BUILD_CONFIGURATION }}
        path: |
          AppPackages/**/*
          !AppPackages/**/*.pdb
        retention-days: 30
        
    - name: Upload certificate (for debugging)
      uses: actions/upload-artifact@v4
      with:
        name: Certificate-${{ matrix.platform }}
        path: |
          ${{ env.CERTIFICATE_NAME }}.pfx
          ${{ env.CERTIFICATE_NAME }}.crt
        retention-days: 7
        
  release:
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/FastCopy-*/**/*
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true
        name: FastCopy ${{ github.ref_name }}
        body: |
          ## FastCopy ${{ github.ref_name }}
          
          ### ğŸ“¦ å®‰è£…åŒ…
          
          - **x64**: é€‚ç”¨äº 64 ä½ Windows ç³»ç»Ÿ
          - **x86**: é€‚ç”¨äº 32 ä½ Windows ç³»ç»Ÿ  
          - **arm64**: é€‚ç”¨äº ARM64 Windows ç³»ç»Ÿ
          
          ### ğŸ” å®‰å…¨è¯´æ˜
          
          æ­¤ç‰ˆæœ¬ä½¿ç”¨è‡ªç­¾åè¯ä¹¦è¿›è¡Œä»£ç ç­¾åã€‚é¦–æ¬¡å®‰è£…æ—¶ï¼ŒWindows å¯èƒ½ä¼šæ˜¾ç¤ºå®‰å…¨è­¦å‘Šã€‚
          è¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œå› ä¸ºè¯ä¹¦ä¸æ˜¯ç”±å—ä¿¡ä»»çš„è¯ä¹¦é¢å‘æœºæ„ç­¾å‘çš„ã€‚
          
          ### ğŸ“‹ å®‰è£…è¯´æ˜
          
          1. ä¸‹è½½é€‚åˆæ‚¨ç³»ç»Ÿæ¶æ„çš„å®‰è£…åŒ…
          2. å³é”®ç‚¹å‡» `.appx` æˆ– `.appxbundle` æ–‡ä»¶
          3. é€‰æ‹©"ä½¿ç”¨PowerShellå®‰è£…"æˆ–ä½¿ç”¨åº”ç”¨å®‰è£…ç¨‹åº
          4. å¦‚æœé‡åˆ°è¯ä¹¦ä¿¡ä»»é—®é¢˜ï¼Œè¯·å®‰è£…æä¾›çš„ `.crt` è¯ä¹¦æ–‡ä»¶åˆ°"å—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„"
          
          ### ğŸ› ï¸ å¼€å‘è€…ä¿¡æ¯
          
          - æ„å»ºæ—¶é—´: ${{ github.run_number }}
          - æäº¤SHA: ${{ github.sha }}
          - åˆ†æ”¯: ${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
